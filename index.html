<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dump Site Vehicle Log</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { padding: 2rem; background: #f8f9fa; }
  .login-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:9999;
  }
  .login-box {
    background:#fff; padding:2rem; border-radius:8px; width:300px;
  }
</style>
</head>
<body>

<div id="loginOverlay" class="login-overlay">
  <div class="login-box text-center">
    <h5>Enter Password</h5>
    <input type="password" id="password" class="form-control mb-3" placeholder="Password" />
    <button class="btn btn-primary" id="loginBtn">Login</button>
    <div id="loginMsg" class="mt-2 text-danger"></div>
  </div>
</div>

<div class="container" style="display:none;" id="formContainer">
<h2 class="mb-4">Waste Management Dump Site Log</h2>
<form id="logForm">
  <div class="mb-3">
    <label for="serial_no" class="form-label">Serial No</label>
    <input type="number" class="form-control" id="serial_no" readonly />
  </div>
  <div class="mb-3">
    <label for="reg_no" class="form-label">Registration Number</label>
    <select class="form-select" id="reg_no" required>
      <option value="">Select Registration</option>
      <option value="ABC123">ABC123</option>
      <option value="XYZ789">XYZ789</option>
      <!-- Add more options as needed -->
    </select>
  </div>
  <div class="mb-3">
    <label for="waste_mngr" class="form-label">Waste Manager</label>
    <select class="form-select" id="waste_mngr" required>
      <option value="">Select Manager</option>
      <option value="John Doe">John Doe</option>
      <option value="Jane Smith">Jane Smith</option>
    </select>
  </div>
  <div class="mb-3">
    <label for="driver" class="form-label">Driver</label>
    <select class="form-select" id="driver" required>
      <option value="">Select Driver</option>
      <option value="Driver 1">Driver 1</option>
      <option value="Driver 2">Driver 2</option>
    </select>
  </div>
  <div class="mb-3">
    <label for="collection_area" class="form-label">Collection Area</label>
    <select class="form-select" id="collection_area" multiple required>
      <option value="North">North</option>
      <option value="South">South</option>
      <option value="East">East</option>
      <option value="West">West</option>
    </select>
  </div>
  <div class="mb-3">
    <label for="date" class="form-label">Date</label>
    <input type="date" class="form-control" id="date" disabled />
  </div>
  <div class="mb-3">
    <label for="time_in" class="form-label">Time In</label>
    <input type="time" class="form-control" id="time_in" readonly />
  </div>
  <div class="mb-3">
    <label for="time_out" class="form-label">Time Out</label>
    <input type="time" class="form-control" id="time_out" readonly />
  </div>
  <div class="mb-3">
    <label for="tonnage" class="form-label">Tonnage</label>
    <input type="number" class="form-control" id="tonnage" min="0" step="0.01" required />
  </div>
  <button type="submit" class="btn btn-success">Submit</button>
</form>

<div class="mt-3" id="statusMsg"></div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz21nRUsKIYwOurl78hRrOj16uAXbSMjrtDHcS9tLxUVyloBvmdVQxgdaoZP4Ri-ppQ/exec"; // Replace with your Apps Script URL
const PASSWORD = "5202"; // Set your simple password here

// Show current date, disable future dates
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('date').value = today;
  document.getElementById('date').setAttribute('max', today);

  // Auto fill current time
  const now = new Date();
  const timeString = now.toTimeString().split(' ')[0].slice(0,5);
  document.getElementById('time_in').value = timeString;
  document.getElementById('time_out').value = timeString;

  // Load serial number
  loadSerialNumber();

  // Set interval to update time_out every minute
  setInterval(() => {
    const now = new Date();
    document.getElementById('time_out').value = now.toTimeString().split(' ')[0].slice(0,5);
  }, 60000);
});

// Login handler
document.getElementById('loginBtn').onclick = () => {
  const pwd = document.getElementById('password').value;
  if (pwd === PASSWORD) {
    document.getElementById('loginOverlay').style.display='none';
    document.getElementById('formContainer').style.display='block';
  } else {
    document.getElementById('loginMsg').innerText='Incorrect password';
  }
};

async function loadSerialNumber() {
  // Fetch last serial number from Sheet via Apps Script
  // For simplicity, you might implement an API or just get the last row
  // Here, assume serial resets daily, so fetch last log and check date
  // For demo, start at 1
  document.getElementById('serial_no').value = 1; // Implement actual logic if needed
}

// Handle form submission
document.getElementById('logForm').onsubmit = async (e) => {
  e.preventDefault();
  const data = {
    reg_no: document.getElementById('reg_no').value,
    waste_mngr: document.getElementById('waste_mngr').value,
    driver: document.getElementById('driver').value,
    collection_area: Array.from(document.getElementById('collection_area').selectedOptions).map(opt => opt.value).join(', '),
    date: document.getElementById('date').value,
    time_in: document.getElementById('time_in').value,
    time_out: document.getElementById('time_out').value,
    tonnage: document.getElementById('tonnage').value
  };

  // Get serial number
  const serial_no = parseInt(document.getElementById('serial_no').value);
  // Save data via Apps Script
  try {
    const response = await fetch(WEBAPP_URL, {
      method: 'POST',
      contentType: 'application/json',
      body: JSON.stringify(data)
    });
    const resJson = await response.json();
    if (resJson.status === 'success') {
      document.getElementById('statusMsg').innerText = `Log saved! Serial No: ${resJson.serial_no}`;
      // Increment serial for next
      document.getElementById('serial_no').value = serial_no + 1;
    }
  } catch (err) {
    document.getElementById('statusMsg').innerText = 'Error saving data.';
  }
};
</script>

</body>
</html>
